<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WaterROC - Extended Leave Status</title>
    <link rel="stylesheet" href="styles/main.css">
    <script src="scripts/dark-mode.js" defer></script>
    <style>
        .extended-leave-container {
            max-width: 1000px;
            margin: 50px auto;
            padding: 30px;
        }
        .status-banner {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            padding: 30px;
            border-radius: 12px;
            text-align: center;
            margin-bottom: 40px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .status-banner h1 {
            margin: 0 0 10px 0;
            font-size: 32px;
        }
        .status-banner p {
            margin: 0;
            font-size: 18px;
            opacity: 0.95;
        }
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }
        .info-card {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .info-card h3 {
            margin: 0 0 15px 0;
            color: #1f2937;
            font-size: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .info-card .icon {
            font-size: 24px;
        }
        .info-card p {
            margin: 8px 0;
            color: #6b7280;
            line-height: 1.6;
        }
        .announcements-section {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
        }
        .announcements-section h2 {
            margin: 0 0 20px 0;
            color: #1f2937;
        }
        .announcement-item {
            padding: 15px;
            background: #f9fafb;
            border-left: 4px solid var(--primary-color);
            border-radius: 6px;
            margin-bottom: 15px;
        }
        .announcement-item h4 {
            margin: 0 0 8px 0;
            color: #1f2937;
        }
        .announcement-item p {
            margin: 0;
            color: #6b7280;
            font-size: 14px;
        }
        .announcement-date {
            font-size: 12px;
            color: #9ca3af;
            margin-top: 8px;
        }
        .contact-section {
            background: #f0f9ff;
            border: 2px solid #bfdbfe;
            border-radius: 12px;
            padding: 25px;
            text-align: center;
        }
        .contact-section h3 {
            margin: 0 0 15px 0;
            color: #1e40af;
        }
        .contact-section p {
            margin: 8px 0;
            color: #1e3a8a;
        }
        .logout-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 30px;
        }
        .logout-btn:hover {
            background: #dc2626;
        }
    </style>
</head>
<body>
    <div class="extended-leave-container">
        <div class="status-banner">
            <h1>üèñÔ∏è Extended Leave Status</h1>
            <p>Welcome back! You are currently on extended leave. Here's what you need to know:</p>
        </div>

        <div class="info-grid">
            <div class="info-card">
                <h3><span class="icon">üë§</span> Your Status</h3>
                <p><strong>Name:</strong> <span id="employeeName">Loading...</span></p>
                <p><strong>Status:</strong> Extended Leave</p>
                <p><strong>Access Level:</strong> View Only</p>
            </div>

            <div class="info-card">
                <h3><span class="icon">üìÖ</span> Important Dates</h3>
                <p><strong>Today:</strong> <span id="currentDate"></span></p>
                <p id="returnDateInfo" style="display: none;"><strong>Expected Return:</strong> <span id="returnDate"></span></p>
            </div>

            <div class="info-card">
                <h3><span class="icon">‚ÑπÔ∏è</span> Access Information</h3>
                <p>While on extended leave, you have limited access to the system.</p>
                <p>You can view company announcements and contact information only.</p>
            </div>
        </div>

        <div class="schedule-overview-section">
            <h2>üìÖ Schedule Overview</h2>
            <div id="scheduleOverview">
                <div style="text-align: center; color: #9ca3af; padding: 20px;">
                    Loading schedule...
                </div>
            </div>
        </div>

        <div class="announcements-section">
            <h2>üì¢ Company Announcements</h2>
            <div id="announcementsList">
                <div style="text-align: center; color: #9ca3af; padding: 20px;">
                    Loading announcements...
                </div>
            </div>
        </div>

        <div class="contact-section">
            <h3>üìû Need Assistance?</h3>
            <p>If you have questions about your leave status or need to make changes, please contact:</p>
            <p><strong>HR Department</strong></p>
            <p>Email: mrsirmaam34@gmail.com</p>
            
        </div>

        <div style="text-align: center;">
            <button id="logoutBtn" class="logout-btn">Logout</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="scripts/config.js"></script>
    <script src="scripts/supabase.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            // Set current date
            const today = new Date();
            document.getElementById('currentDate').textContent = today.toLocaleDateString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });

            // Check authentication
            if (typeof supabaseService === 'undefined') {
                window.location.href = 'index.html';
                return;
            }

            // Wait for Supabase to initialize
            let attempts = 0;
            while (!supabaseService.isReady() && attempts < 50) {
                await new Promise(resolve => setTimeout(resolve, 100));
                attempts++;
            }

            if (!supabaseService.isReady()) {
                alert('Connection error. Please refresh the page.');
                return;
            }

            // Load current user
            await supabaseService.loadCurrentUser();
            const user = await supabaseService.getCurrentUser();

            if (!user) {
                window.location.href = 'index.html';
                return;
            }

            // Display user name
            document.getElementById('employeeName').textContent = user.full_name || user.username;

            // Load schedule overview
            await loadScheduleOverview();

            // Load announcements
            await loadAnnouncements();

            // Logout handler
            document.getElementById('logoutBtn').addEventListener('click', async () => {
                await supabaseService.signOut();
                sessionStorage.clear();
                window.location.href = 'index.html';
            });
        });

        async function loadScheduleOverview() {
            try {
                // Get current employee
                const employee = await supabaseService.getCurrentEmployee();
                if (!employee) {
                    document.getElementById('scheduleOverview').innerHTML = 
                        '<div class="schedule-empty">Unable to load employee information</div>';
                    return;
                }

                const employeeId = employee.id;
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                // Get upcoming shifts (next 30 days)
                const { data: shifts, error: shiftsError } = await supabaseService.client
                    .from('employee_shifts')
                    .select('*')
                    .eq('employee_id', employeeId)
                    .gte('shift_date', today.toISOString().split('T')[0])
                    .order('shift_date', { ascending: true })
                    .limit(20);

                // Get upcoming tasks (next 30 days)
                const { data: tasks, error: tasksError } = await supabaseService.client
                    .from('tasks')
                    .select('*')
                    .eq('employee_id', employeeId)
                    .gte('end_date', today.toISOString().split('T')[0])
                    .order('start_date', { ascending: true })
                    .limit(20);

                // Get time off requests
                const { data: timeOffRequests, error: timeOffError } = await supabaseService.client
                    .from('time_off_requests')
                    .select('*')
                    .eq('employee_id', employeeId)
                    .eq('status', 'approved')
                    .gte('end_date', today.toISOString().split('T')[0])
                    .order('start_date', { ascending: true })
                    .limit(5);

                const scheduleOverview = document.getElementById('scheduleOverview');

                if (shiftsError || tasksError || timeOffError) {
                    console.error('Error loading schedule:', shiftsError || tasksError || timeOffError);
                    scheduleOverview.innerHTML = '<div class="schedule-empty">Unable to load schedule information</div>';
                    return;
                }

                let html = '';

                // Time Off Section
                if (timeOffRequests && timeOffRequests.length > 0) {
                    html += '<h3 style="margin: 0 0 15px 0; color: #1f2937; font-size: 18px;">üèñÔ∏è Approved Time Off</h3>';
                    timeOffRequests.forEach(req => {
                        const startDate = new Date(req.start_date).toLocaleDateString('en-US', {
                            month: 'short',
                            day: 'numeric',
                            year: 'numeric'
                        });
                        const endDate = new Date(req.end_date).toLocaleDateString('en-US', {
                            month: 'short',
                            day: 'numeric',
                            year: 'numeric'
                        });
                        html += `
                            <div class="schedule-item">
                                <h4>Time Off</h4>
                                <p class="schedule-date">${startDate} - ${endDate}</p>
                                ${req.reason ? `<p>Reason: ${req.reason}</p>` : ''}
                            </div>
                        `;
                    });
                }

                // Upcoming Shifts Section
                if (shifts && shifts.length > 0) {
                    html += '<h3 style="margin: 20px 0 15px 0; color: #1f2937; font-size: 18px;">üìÖ Upcoming Shifts</h3>';
                    shifts.forEach(shift => {
                        const shiftDate = new Date(shift.shift_date).toLocaleDateString('en-US', {
                            weekday: 'short',
                            month: 'short',
                            day: 'numeric',
                            year: 'numeric'
                        });
                        const startTime = shift.start_time ? shift.start_time.substring(0, 5) : 'N/A';
                        const endTime = shift.end_time ? shift.end_time.substring(0, 5) : 'N/A';
                        html += `
                            <div class="schedule-item">
                                <h4>${shiftDate}</h4>
                                <p>Time: ${startTime} - ${endTime}</p>
                                ${shift.work_area ? `<p>Area: ${shift.work_area}</p>` : ''}
                                ${shift.notes ? `<p>Notes: ${shift.notes}</p>` : ''}
                            </div>
                        `;
                    });
                }

                // Upcoming Tasks Section
                if (tasks && tasks.length > 0) {
                    html += '<h3 style="margin: 20px 0 15px 0; color: #1f2937; font-size: 18px;">‚úÖ Upcoming Tasks</h3>';
                    tasks.forEach(task => {
                        const taskDate = new Date(task.start_date).toLocaleDateString('en-US', {
                            weekday: 'short',
                            month: 'short',
                            day: 'numeric',
                            year: 'numeric'
                        });
                        const startTime = task.start_time ? task.start_time.substring(0, 5) : 'N/A';
                        const endTime = task.end_time ? task.end_time.substring(0, 5) : 'N/A';
                        html += `
                            <div class="schedule-item">
                                <h4>${task.name || 'Task'}</h4>
                                <p class="schedule-date">${taskDate}</p>
                                <p>Time: ${startTime} - ${endTime}</p>
                                ${task.work_area ? `<p>Area: ${task.work_area}</p>` : ''}
                                ${task.description ? `<p>${task.description}</p>` : ''}
                            </div>
                        `;
                    });
                }

                if (!html) {
                    html = '<div class="schedule-empty">No upcoming schedule items</div>';
                }

                scheduleOverview.innerHTML = html;
            } catch (error) {
                console.error('Error loading schedule overview:', error);
                document.getElementById('scheduleOverview').innerHTML = 
                    '<div class="schedule-empty">Error loading schedule information</div>';
            }
        }

        async function loadAnnouncements() {
            try {
                const { data: announcements, error } = await supabaseService.client
                    .from('announcements')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(10);

                const announcementsList = document.getElementById('announcementsList');

                if (error) {
                    console.error('Error loading announcements:', error);
                    announcementsList.innerHTML = '<p style="text-align: center; color: #9ca3af;">Unable to load announcements</p>';
                    return;
                }

                if (!announcements || announcements.length === 0) {
                    announcementsList.innerHTML = '<p style="text-align: center; color: #9ca3af;">No announcements at this time</p>';
                    return;
                }

                announcementsList.innerHTML = announcements.map(announcement => {
                    const date = new Date(announcement.created_at).toLocaleDateString('en-US', {
                        month: 'short',
                        day: 'numeric',
                        year: 'numeric'
                    });
                    
                    return `
                        <div class="announcement-item">
                            <h4>${announcement.title}</h4>
                            <p>${announcement.message}</p>
                            <div class="announcement-date">Posted on ${date}</div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading announcements:', error);
                document.getElementById('announcementsList').innerHTML = 
                    '<p style="text-align: center; color: #9ca3af;">Error loading announcements</p>';
            }
        }
    </script>
</body>
</html>
