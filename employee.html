<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WaterROC - Employee Dashboard</title>
    <link rel="icon" type="image/png" href="/favicon.png">
    <link rel="shortcut icon" type="image/png" href="/favicon.png">
    <link rel="stylesheet" href="styles/main.css">
    <link rel="stylesheet" href="styles/gantt.css">
    <link rel="stylesheet" href="styles/checkin.css">
    <link rel="stylesheet" href="styles/company-chat.css">
    <link rel="stylesheet" href="styles/employee-layout-fix.css">
    <link rel="stylesheet" href="styles/voip.css">
    <script src="scripts/dark-mode.js" defer></script>
</head>
<body class="employee-page">
    <div class="dashboard">
        <header class="dashboard-header">
            <div class="header-left">
                <!-- ADDED: Favicon logo image -->
                <img src="favicon.png" alt="WaterROC Logo" class="header-logo" onerror="this.style.display='none';">
                <h1>WaterROC</h1>
            </div>
            <div class="header-right">
                <button id="notificationBtn" class="notification-btn">
                    üîî
                    <span id="notificationBadge" class="notification-badge">0</span>
                </button>
                <span class="user-info">Employee View</span>
                <button id="clockInBtn" class="btn-primary" data-state="out">Clock In</button>
                <span id="clockStatus" style="margin:0 10px; font-weight:600;">Not clocked in</span>
                <button id="logoutBtn" class="btn-secondary">Logout</button>
            </div>
            <!-- Dark mode toggle will be inserted here by dark-mode.js -->
        </header>
        
        <!-- Announcement Banner -->
        <div id="announcementBanner" class="announcement-banner-container"></div>
        
        <div class="dashboard-content">
            <div class="info-panel">
                <div class="info-card">
                    <h3>Schedule Overview</h3>
                    <p>View your team's schedule and assignments</p>
                    <div style="margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                        <a href="employee-tasks.html" class="btn-primary" style="text-decoration: none;">üìã My Tasks</a>
                        <button id="viewMyShiftsBtn" class="btn-primary">My Shifts</button>
                        <button id="editMyProfileBtn" class="btn-primary">My Profile</button>
                        <button id="viewMyPaycheckBtn" class="btn-primary">üí∞ My Paycheck</button>
                        <button id="viewMyTransactionsBtn" class="btn-primary">üí≥ Transaction History</button>
                        <a href="store.html" class="btn-primary" style="text-decoration: none;">üõí Store</a>
                        <a href="stock-market.html" class="btn-primary" style="text-decoration: none;">üìà Stock Market</a>
                        <button id="manage401kBtn" class="btn-primary">üíº 401k Plan</button>
                        <button id="manageSMPBtn" class="btn-primary">üìä Stock Purchase Plan</button>
                        <a href="email.html" class="btn-primary" style="text-decoration: none;">üìß Email</a>
                        <a href="swa-ops.html" class="btn-primary" style="text-decoration: none;">‚úàÔ∏è SWA OPS</a>
                        <button id="requestTimeOffBtn" class="btn-primary">Request Time Off</button>
                    </div>
                </div>
                
                <div class="info-card">
                    <h3>Task Status Legend</h3>
                    <!-- FULL OVERHAUL: Muted color legend - blue/gray shades only -->
                    <div class="color-legend">
                        <div class="legend-item">
                            <span class="color-box" style="background-color: #4a90e2;"></span>
                            <span>In Progress</span>
                        </div>
                        <div class="legend-item">
                            <span class="color-box" style="background-color: #6c757d;"></span>
                            <span>Completed</span>
                        </div>
                        <div class="legend-item">
                            <span class="color-box" style="background-color: #5a9fd4;"></span>
                            <span>Pending</span>
                        </div>
                        <div class="legend-item">
                            <span class="color-box" style="background-color: #495057;"></span>
                            <span>Overdue</span>
                        </div>
                        <div class="legend-item">
                            <span class="color-box" style="background-color: #868e96;"></span>
                            <span>On Hold</span>
                        </div>
                    </div>
                </div>
                
                <div class="info-card">
                    <h3>üìû Team Members</h3>
                    <p>Call your colleagues</p>
                    <div id="teamMembersList" style="margin-top: 15px; max-height: 400px; overflow-y: auto;">
                        <div class="loading-message">Loading team members...</div>
                    </div>
                </div>
                
            </div>
            
            <div class="gantt-container">
                <!-- Gantt controls bar with scale selector and zoom buttons -->
                <div class="gantt-controls-bar">
                    <div class="gantt-controls-left">
                        <!-- Scale selector and zoom buttons for Gantt -->
                        <select id="ganttScaleSelector" class="gantt-scale-selector" title="Select zoom level">
                            <option value="week">Week View</option>
                            <option value="month" selected>Month View</option>
                            <option value="day">Day View</option>
                            <option value="hour">Hour View</option>
                        </select>
                        <button id="zoomOutBtn" class="btn-secondary btn-small" title="Zoom out">‚àí</button>
                        <button id="zoomInBtn" class="btn-secondary btn-small" title="Zoom in">+</button>
                        <button id="zoomResetBtn" class="btn-secondary btn-small" title="Reset zoom">Reset</button>
                    </div>
                </div>
                <div id="ganttChart" class="gantt-chart readonly"></div>
                
                <!-- Summary Section -->
                <div id="scheduleSummary" class="schedule-summary">
                    <h3>üìä Schedule Summary</h3>
                    <div class="summary-grid">
                        <div class="summary-card">
                            <div class="summary-icon">üìÖ</div>
                            <div class="summary-content">
                                <div class="summary-label">Upcoming Shifts</div>
                                <div class="summary-value" id="upcomingShiftsCount">-</div>
                            </div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-icon">‚úÖ</div>
                            <div class="summary-content">
                                <div class="summary-label">Active Tasks</div>
                                <div class="summary-value" id="activeTasksCount">-</div>
                            </div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-icon">‚è∞</div>
                            <div class="summary-content">
                                <div class="summary-label">Hours This Week</div>
                                <div class="summary-value" id="weeklyHours">-</div>
                            </div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-icon">üìã</div>
                            <div class="summary-content">
                                <div class="summary-label">Tasks This Week</div>
                                <div class="summary-value" id="weeklyTasksCount">-</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Task Details Modal (Read-Only) -->
    <div id="taskDetailsModal" class="modal">
        <div class="modal-content modal-content-large">
            <span class="close">&times;</span>
            <h2>Task Details</h2>
            <div id="taskDetails" class="task-details-content"></div>
            <div class="task-actions">
                <button id="acknowledgeBtn" class="btn-success">‚úì Acknowledge Task</button>
                <button id="unacknowledgeBtn" class="btn-secondary" style="display:none;">Remove Acknowledgement</button>
            </div>
            
            <!-- Task Messages Section -->
            <div class="task-messages-section">
                <h3>üí¨ Messages</h3>
                <div id="taskMessagesList" class="task-messages-list">
                    <!-- Messages will be rendered here -->
                </div>
                <div class="task-message-input">
                    <textarea id="messageInput" placeholder="Ask a question or send a message to admin..." rows="3"></textarea>
                    <button id="sendMessageBtn" class="btn-primary">Send Message</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Notification Panel -->
    <div class="notification-overlay" id="notificationOverlay"></div>
    <div class="notification-panel" id="notificationPanel">
        <div class="notification-header">
            <h3>üîî Notifications</h3>
            <div class="notification-actions">
                <button class="notification-action-btn" id="markAllReadBtn">Mark all read</button>
                <button class="notification-action-btn" id="clearAllBtn">Clear</button>
                <button class="notification-action-btn" id="closeNotificationBtn">‚úï</button>
            </div>
        </div>
        <div class="notification-list" id="notificationList">
            <!-- Notifications will be rendered here -->
        </div>
    </div>

    <!-- My Shifts Modal -->
    <div id="myShiftsModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2>üìÖ My Shifts</h2>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
                    <button id="myShiftsPrevWeek" class="btn-secondary">‚Üê Previous Week</button>
                    <span id="myShiftsWeekDisplay" style="font-weight: 600;"></span>
                    <button id="myShiftsNextWeek" class="btn-secondary">Next Week ‚Üí</button>
                </div>
                <div id="myShiftsContent" style="overflow-x: auto;">
                    <div class="loading-message">Loading your shifts...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- My Profile Modal -->
    <div id="myProfileModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2>üë§ My Profile</h2>
                <span class="close">&times;</span>
            </div>
            <form id="myProfileForm">
                <div class="form-group">
                    <label for="myProfileName">Name</label>
                    <input type="text" id="myProfileName" readonly>
                </div>

                <div class="form-group">
                    <label for="myProfilePhone">Phone Number</label>
                    <input type="tel" id="myProfilePhone" placeholder="(555) 123-4567">
                </div>

                <div class="form-group">
                    <label for="myProfileEmail">Email</label>
                    <input type="email" id="myProfileEmail" placeholder="your.email@example.com">
                </div>

                <div class="form-group">
                    <label for="myProfileSkills">Skills (comma-separated)</label>
                    <input type="text" id="myProfileSkills" placeholder="Plumbing, Welding, Electrical">
                    <small>Enter your skills separated by commas</small>
                </div>

                <div class="form-group">
                    <label for="myProfileCertifications">Certifications (comma-separated)</label>
                    <input type="text" id="myProfileCertifications" placeholder="EPA Cross-Connection, Backflow Prevention">
                    <small>Enter your certifications separated by commas</small>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn-secondary" id="cancelMyProfileBtn">Cancel</button>
                    <button type="submit" class="btn-primary">üíæ Save Profile</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- My Paycheck Modal -->
    <div id="myPaycheckModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2>üí∞ My Paycheck</h2>
                <span class="close" id="closeMyPaycheckModal">&times;</span>
            </div>
            <div class="modal-body">
                <div id="paycheckContent">
                    <div style="text-align: center; padding: 40px; color: #64748b;">
                        <div class="loading-message">Loading paycheck information...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Transaction History Modal -->
    <div id="myTransactionsModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2>üí≥ Transaction History</h2>
                <span class="close" id="closeMyTransactionsModal">&times;</span>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 20px;">
                    <input type="text" id="transactionSearchInput" placeholder="Search transactions..." 
                           style="width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 4px;">
                </div>
                <div style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                    <select id="transactionTypeFilter" style="padding: 8px; border: 1px solid #e5e7eb; border-radius: 4px;">
                        <option value="all">All Types</option>
                        <option value="payroll">Payroll</option>
                        <option value="purchase">Purchases</option>
                        <option value="garnishment">Garnishments & Deductions</option>
                        <option value="stock_buy">Stock Purchases</option>
                        <option value="stock_sell">Stock Sales</option>
                        <option value="stock_loss">Stock Losses</option>
                    </select>
                    <select id="transactionDateFilter" style="padding: 8px; border: 1px solid #e5e7eb; border-radius: 4px;">
                        <option value="all">All Time</option>
                        <option value="week">Last Week</option>
                        <option value="month">Last Month</option>
                        <option value="quarter">Last 3 Months</option>
                        <option value="year">Last Year</option>
                    </select>
                </div>
                <div id="transactionsContent" style="max-height: 600px; overflow-y: auto;">
                    <div style="text-align: center; padding: 40px; color: #64748b;">
                        <div class="loading-message">Loading transaction history...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 401k Plan Modal -->
    <div id="manage401kModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2>üíº 401k Retirement Plan</h2>
                <span class="close" id="close401kModal">&times;</span>
            </div>
            <div class="modal-body">
                <div id="401kContent">
                    <div id="401kEnrollment" style="display: none;">
                        <p style="color: #64748b; margin-bottom: 20px;">
                            Enroll in the company 401k plan. Your contributions will be deducted from your paycheck, and the company will match a portion of your contributions.
                        </p>
                        <form id="401kEnrollmentForm">
                            <div class="form-group">
                                <label for="401kContributionPercent">Contribution Percentage (% of paycheck)</label>
                                <input type="number" id="401kContributionPercent" min="0" max="100" step="0.01" value="3.00" required>
                                <small style="color: #6b7280;">Recommended: 3-10%</small>
                            </div>
                            <div class="form-group">
                                <label for="401kMaxContribution">Annual Contribution Limit (Optional)</label>
                                <input type="number" id="401kMaxContribution" min="0" step="0.01" placeholder="Leave blank for no limit">
                            </div>
                            <button type="submit" class="btn-primary">Enroll in 401k</button>
                        </form>
                    </div>
                    <div id="401kDetails" style="display: none;">
                        <div style="background: #f9fafb; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                            <h3>Your 401k Account</h3>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                                <div>
                                    <div style="font-size: 12px; color: #6b7280;">Current Balance</div>
                                    <div id="401kBalance" style="font-size: 24px; font-weight: bold; color: #3b82f6;">$0.00</div>
                                </div>
                                <div>
                                    <div style="font-size: 12px; color: #6b7280;">Contribution Rate</div>
                                    <div id="401kContributionRate" style="font-size: 24px; font-weight: bold;">0%</div>
                                </div>
                                <div>
                                    <div style="font-size: 12px; color: #6b7280;">Total Contributed</div>
                                    <div id="401kTotalContributed" style="font-size: 18px; font-weight: 600;">$0.00</div>
                                </div>
                                <div>
                                    <div style="font-size: 12px; color: #6b7280;">Employer Match</div>
                                    <div id="401kEmployerMatch" style="font-size: 18px; font-weight: 600; color: #10b981;">$0.00</div>
                                </div>
                            </div>
                        </div>
                        <form id="401kUpdateForm">
                            <div class="form-group">
                                <label for="401kUpdatePercent">Update Contribution Percentage (%)</label>
                                <input type="number" id="401kUpdatePercent" min="0" max="100" step="0.01" required>
                            </div>
                            <div class="form-group">
                                <button type="submit" class="btn-primary">Update Contribution</button>
                                <button type="button" id="pause401kBtn" class="btn-secondary" style="margin-left: 10px;">Pause Contributions</button>
                            </div>
                        </form>
                        <div style="margin-top: 30px;">
                            <h4>Contribution History</h4>
                            <div id="401kHistory" style="max-height: 300px; overflow-y: auto; margin-top: 10px;">
                                <div style="text-align: center; padding: 20px; color: #64748b;">No contributions yet</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Stock Market Plan (SMP) Modal -->
    <div id="manageSMPModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2>üìä Stock Market Purchase Plan (SMP)</h2>
                <span class="close" id="closeSMPModal">&times;</span>
            </div>
            <div class="modal-body">
                <div id="SMPContent">
                    <div id="SMPEnrollment" style="display: none;">
                        <p style="color: #64748b; margin-bottom: 20px;">
                            Enroll in the Stock Market Purchase Plan. A percentage of your paycheck will automatically purchase company stock at a discount.
                        </p>
                        <form id="SMPEnrollmentForm">
                            <div class="form-group">
                                <label for="SMPContributionPercent">Contribution Percentage (% of paycheck)</label>
                                <input type="number" id="SMPContributionPercent" min="0" max="100" step="0.01" value="5.00" required>
                                <small style="color: #6b7280;">Recommended: 5-15%</small>
                            </div>
                            <div class="form-group">
                                <label for="SMPMaxContribution">Max Contribution Per Pay Period (Optional)</label>
                                <input type="number" id="SMPMaxContribution" min="0" step="0.01" placeholder="Leave blank for no limit">
                            </div>
                            <div class="form-group">
                                <label for="SMPStockSymbol">Stock to Purchase</label>
                                <select id="SMPStockSymbol" required>
                                    <option value="">Select a stock...</option>
                                </select>
                            </div>
                            <button type="submit" class="btn-primary">Enroll in SMP</button>
                        </form>
                    </div>
                    <div id="SMPDetails" style="display: none;">
                        <div style="background: #f9fafb; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                            <h3>Your SMP Enrollment</h3>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                                <div>
                                    <div style="font-size: 12px; color: #6b7280;">Contribution Rate</div>
                                    <div id="SMPContributionRate" style="font-size: 24px; font-weight: bold;">0%</div>
                                </div>
                                <div>
                                    <div style="font-size: 12px; color: #6b7280;">Stock Symbol</div>
                                    <div id="SMPStockSymbolDisplay" style="font-size: 24px; font-weight: bold; color: #3b82f6;">-</div>
                                </div>
                                <div>
                                    <div style="font-size: 12px; color: #6b7280;">Total Shares Purchased</div>
                                    <div id="SMPTotalShares" style="font-size: 18px; font-weight: 600;">0</div>
                                </div>
                                <div>
                                    <div style="font-size: 12px; color: #6b7280;">Total Contributed</div>
                                    <div id="SMPTotalContributed" style="font-size: 18px; font-weight: 600;">$0.00</div>
                                </div>
                            </div>
                        </div>
                        <form id="SMPUpdateForm">
                            <div class="form-group">
                                <label for="SMPUpdatePercent">Update Contribution Percentage (%)</label>
                                <input type="number" id="SMPUpdatePercent" min="0" max="100" step="0.01" required>
                            </div>
                            <div class="form-group">
                                <button type="submit" class="btn-primary">Update Contribution</button>
                                <button type="button" id="pauseSMPBtn" class="btn-secondary" style="margin-left: 10px;">Pause Contributions</button>
                            </div>
                        </form>
                        <div style="margin-top: 30px;">
                            <h4>Purchase History</h4>
                            <div id="SMPHistory" style="max-height: 300px; overflow-y: auto; margin-top: 10px;">
                                <div style="text-align: center; padding: 20px; color: #64748b;">No purchases yet</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Time Off Request Modal -->
    <div id="timeOffModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2>üèñÔ∏è Request Time Off</h2>
                <button class="close-modal" id="closeTimeOffModal">&times;</button>
            </div>
            <form id="timeOffForm">
                <div class="form-group">
                    <label for="timeOffStartDate">Start Date</label>
                    <input type="date" id="timeOffStartDate" required>
                </div>

                <div class="form-group">
                    <label for="timeOffEndDate">End Date</label>
                    <input type="date" id="timeOffEndDate" required>
                </div>

                <div class="form-group">
                    <label for="timeOffReason">Reason</label>
                    <textarea id="timeOffReason" rows="4" placeholder="Enter reason for time off..." required></textarea>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn-secondary" id="cancelTimeOffBtn">Cancel</button>
                    <button type="submit" class="btn-primary">üì§ Submit Request</button>
                </div>
            </form>

            <!-- My Time Off Requests List -->
            <div style="margin-top: 30px; border-top: 1px solid #e5e7eb; padding-top: 20px;">
                <h3>My Time Off Requests</h3>
                <div id="myTimeOffRequestsList"></div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Immediate authentication check - runs before page loads
        (function() {
            const employmentStatus = sessionStorage.getItem('employmentStatus');
            const userRole = sessionStorage.getItem('userRole');
            
            // Check if user is on extended leave
            if (employmentStatus === 'extended_leave') {
                window.location.href = 'extended-leave.html';
                return;
            }
            
            // Check if user is authenticated
            if (!userRole || userRole !== 'employee') {
                window.location.href = 'index.html';
                return;
            }
        })();
    </script>
    <script src="scripts/supabase.js"></script>
    <script src="scripts/config.js"></script>
    <script src="scripts/loading-screen.js" defer></script>
    <script src="scripts/employee-status-monitor.js"></script>
    <script src="scripts/clock-in.js"></script>
    <script src="scripts/checkin.js"></script>
    <script src="scripts/notifications.js"></script>
    <script src="scripts/announcement-banner.js"></script>
    <script src="scripts/gantt.js"></script>
    <script src="scripts/employee.js"></script>
    <script src="scripts/company-chat.js"></script>
    <script src="scripts/voip-call-manager.js"></script>
    <script src="scripts/voip-ui.js"></script>
    <script>
        // Initialize VOIP on page load
        document.addEventListener('DOMContentLoaded', async () => {
            // Show page load screen on initial load
            if (typeof showPageLoadScreen !== 'undefined') {
                showPageLoadScreen();
            }
            if (typeof voipUI !== 'undefined') {
                await voipUI.initialize();
            }
        });
    </script>
</script>
</body>
</html>
