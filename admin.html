<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WaterROC - Admin Dashboard</title>
    <link rel="icon" type="image/png" href="/favicon.png">
    <link rel="shortcut icon" type="image/png" href="/favicon.png">
    <link rel="stylesheet" href="styles/main.css">
    <link rel="stylesheet" href="styles/gantt.css">
    <link rel="stylesheet" href="styles/hourly-gantt.css">
    <link rel="stylesheet" href="styles/company-chat.css">
    <link rel="stylesheet" href="styles/voip.css">
    <link rel="stylesheet" href="styles/gantt-context-menu.css">
    <link rel="stylesheet" href="styles/admin-mobile.css">
    <script src="scripts/loading-screen.js" defer></script>
    <script src="scripts/dark-mode.js" defer></script>
    <script src="scripts/gantt-context-menu.js" defer></script>
    <script src="scripts/hourly-gantt-context-menu.js" defer></script>
</head>
<body>
    <script>
        // DISABLED: Page load screen was blocking all interactions and preventing Gantt from rendering
        // Only show loading screens for specific user actions, not on initial page load
    </script>
    <div class="dashboard">
        <header class="dashboard-header">
            <div class="header-left">
                <!-- ADDED: Favicon logo image -->
                <img src="favicon.png" alt="WaterROC Logo" class="header-logo" onerror="this.style.display='none';">
                <h1>WaterROC</h1>
            </div>
            <div class="header-right">
                <!-- ADDED UI: Notification button with tooltip -->
                <button id="notificationBtn" class="notification-btn" title="View notifications">
                    üîî
                    <span id="notificationBadge" class="notification-badge">0</span>
                </button>
                <span class="user-info" title="Current user role">Admin Dashboard</span>
                <button id="mobileMenuBtn" class="btn-secondary mobile-only" title="Open admin menu">Menu</button>
                <button id="logoutBtn" class="btn-secondary" title="Logout from the system">Logout</button>
            </div>
            <!-- Dark mode toggle will be inserted here by dark-mode.js -->
        </header>
        
        <!-- Announcement Banner -->
        <div id="announcementBanner" class="announcement-banner-container"></div>
        
        <div class="dashboard-content">
            <div class="controls-panel">
                <!-- Mobile-only drawer header -->
                <div class="mobile-controls-header mobile-only">
                    <div class="mobile-controls-title">Admin Menu</div>
                    <button id="mobileMenuCloseBtn" class="btn-secondary" title="Close admin menu">Close</button>
                </div>

                <!-- Mobile-only quick actions -->
                <div class="mobile-quick-actions mobile-only">
                    <div class="mobile-quick-actions-grid">
                        <button id="mobileQuickAddTaskBtn" class="btn-primary" title="Create a new task assignment">+ Task</button>
                        <button id="mobileQuickAddEmployeeBtn" class="btn-primary" title="Add a new employee to the system">+ Personnel</button>
                        <button id="mobileQuickSaveBtn" class="btn-primary btn-muted" title="Save all changes to the schedule">Save</button>
                        <button id="mobileQuickShiftsBtn" class="btn-primary btn-muted" title="Schedule employee shifts">Shifts</button>
                    </div>
                </div>

                <div class="controls-section">
                    <h3>Gantt Chart Controls</h3>
                    <!-- FULL OVERHAUL: Muted blue/gray buttons, no yellow/green/orange -->
                    <div class="control-group">
                        <!-- ADDED UI: Buttons with tooltips -->
                        <button id="addEmployeeBtn" class="btn-primary" title="Add a new employee to the system">Add Personnel</button>
                        <button id="addTaskBtn" class="btn-primary" title="Create a new task assignment">Add Task</button>
                        <button id="sendAnnouncementBtn" class="btn-primary btn-muted" title="Send announcement to all employees">Send Announcement</button>
                        <button id="viewAnalyticsBtn" class="btn-primary btn-muted" title="View analytics and reports">View Analytics</button>
                        <button id="saveDataBtn" class="btn-primary btn-muted" title="Save all changes to the schedule">Save Changes</button>
                        <button id="resetViewBtn" class="btn-secondary" title="Reset Gantt view to default">Reset View</button>
                    </div>
                </div>
                
                <div class="controls-section">
                    <h3>Date Range</h3>
                    <div class="date-controls">
                        <input type="date" id="startDate" />
                        <span>to</span>
                        <input type="date" id="endDate" />
                        <button id="updateDateRange" class="btn-secondary">Update</button>
                    </div>
                </div>
                
                <div class="controls-section">
                    <h3>Advanced Features</h3>
                    <!-- FULL OVERHAUL: Muted blue buttons -->
                    <div class="control-group">
                        <!-- ADDED UI: Advanced feature buttons with tooltips -->
                        <button id="manageProfilesBtn" class="btn-primary btn-muted" title="Manage employee profiles">Personnel Profiles</button>
                        <button id="manageShiftsBtn" class="btn-primary btn-muted" title="Schedule employee shifts">Shift Scheduling</button>
                        <a href="crew-scheduling.html" class="btn-primary btn-muted" style="text-decoration: none;" title="Schedule crew for virtual airline flights">‚úàÔ∏è Crew Scheduling</a>
                        <button id="manageTaskTemplatesBtn" class="btn-primary btn-muted" title="Manage task templates">Task Templates</button>
                        <button id="manageExceptionsBtn" class="btn-primary btn-muted" title="Manage exceptions and absences">Exceptions & Absence</button>
                    </div>
                </div>
                
                <div class="controls-section">
                    <h3>Payroll Management</h3>
                    <div class="control-group">
                        <button id="managePayrollHoursBtn" class="btn-primary btn-muted" title="Set payroll hours for employees">Set Payroll Hours</button>
                        <button id="manageAccountantAccessBtn" class="btn-primary btn-muted" title="Designate employees for accountant access">Accountant Access</button>
                        <button id="managePayRatesBtn" class="btn-primary btn-muted" title="Manage employee pay rates">Pay Rates</button>
                        <button id="manageGarnishmentsBtn" class="btn-primary btn-muted" title="Garnish employee wages">Wage Garnishments</button>
                        <button id="viewEmployeeBalancesBtn" class="btn-primary btn-muted" title="View employee wallet balances">Employee Balances</button>
                    </div>
                </div>
                
                <div class="controls-section">
                    <h3>Stock Market</h3>
                    <div class="control-group">
                        <button id="manageStocksBtn" class="btn-primary btn-muted" title="Add and manage stocks">Manage Stocks</button>
                    </div>
                </div>
                
                <div class="controls-section">
                    <h3>Color Legend</h3>
                    <!-- FULL OVERHAUL: Muted color legend - blue/gray shades only -->
                    <!-- ADDED UI: Muted color legend with tooltips -->
                    <div class="color-legend">
                        <div class="legend-item" title="Tasks currently in progress">
                            <span class="color-box" style="background-color: #4a90e2;"></span>
                            <span>In Progress</span>
                        </div>
                        <div class="legend-item" title="Completed tasks">
                            <span class="color-box" style="background-color: #6c757d;"></span>
                            <span>Completed</span>
                        </div>
                        <div class="legend-item" title="Pending tasks">
                            <span class="color-box" style="background-color: #5a9fd4;"></span>
                            <span>Pending</span>
                        </div>
                        <div class="legend-item" title="Overdue tasks">
                            <span class="color-box" style="background-color: #495057;"></span>
                            <span>Overdue</span>
                        </div>
                        <div class="legend-item" title="Tasks on hold">
                            <span class="color-box" style="background-color: #868e96;"></span>
                            <span>On Hold</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="gantt-container">
                <div class="mobile-hint mobile-only">
                    Swipe to scroll the timeline. Use the zoom selector or +/‚àí for detail.
                </div>
                <!-- ADDED UI: Gantt controls bar with search, zoom, export -->
                <div class="gantt-controls-bar">
                    <div class="gantt-controls-left">
                        <!-- ADDED UI: Search bar for employees -->
                        <input type="text" id="employeeSearch" class="gantt-search" placeholder="Search employees..." title="Search for employees by name">
                        <!-- ADDED UI: Scale selector and zoom buttons for Gantt -->
                        <select id="ganttScaleSelector" class="gantt-scale-selector" title="Select zoom level">
                            <option value="week">Week View</option>
                            <option value="month" selected>Month View</option>
                            <option value="day">Day View</option>
                            <option value="hour">Hour View</option>
                        </select>
                        <button id="zoomOutBtn" class="btn-secondary btn-small" title="Zoom out">‚àí</button>
                        <button id="zoomInBtn" class="btn-secondary btn-small" title="Zoom in">+</button>
                        <button id="zoomResetBtn" class="btn-secondary btn-small" title="Reset zoom">Reset</button>
                    </div>
                    <div class="gantt-controls-right">
                        <!-- ADDED UI: Export CSV button -->
                        <button id="exportCSVBtn" class="btn-primary btn-muted" title="Export schedule to CSV">Export CSV</button>
                    </div>
                </div>
                <div id="ganttChart" class="gantt-chart"></div>
            </div>
        </div>
    </div>

    <!-- Mobile controls overlay (tap to close drawer) -->
    <div id="mobileControlsOverlay" class="mobile-controls-overlay"></div>
    
    <!-- Add Employee Modal -->
    <div id="addEmployeeModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Add Employee</h2>
            <form id="addEmployeeForm">
                <div class="form-group">
                    <label for="linkUserAccount">Link to User Account (Optional)</label>
                    <select id="linkUserAccount">
                        <option value="">-- No User Account --</option>
                    </select>
                    <small style="color: #64748b; display: block; margin-top: 4px;">
                        Select a user to link their login account to this employee
                    </small>
                </div>
                <div class="form-group">
                    <label for="employeeName">Employee Name</label>
                    <input type="text" id="employeeName" required>
                </div>
                <div class="form-group">
                    <label for="employeeRole">Role/Position</label>
                    <input type="text" id="employeeRole" required>
                </div>
                <button type="submit" class="btn-primary">Add Employee</button>
            </form>
        </div>
    </div>
    
    <!-- Add Task Modal -->
    <div id="addTaskModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Add Task</h2>
            <form id="addTaskForm">
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="taskSendToAll" style="margin-right: 8px;">
                        Send to all employees
                    </label>
                </div>
                <div class="form-group" id="taskEmployeeGroup">
                    <label for="taskEmployee">Employee</label>
                    <select id="taskEmployee" required></select>
                </div>
                <div class="form-group">
                    <label for="taskName">Task Name</label>
                    <input type="text" id="taskName" required>
                </div>
                <div class="form-group">
                    <label for="taskStart">Start Date</label>
                    <input type="date" id="taskStart" required>
                </div>
                <div class="form-group">
                    <label for="taskStartTime">Start Time (HHMM)</label>
                    <input type="time" id="taskStartTime" required>
                </div>
                <div class="form-group">
                    <label for="taskEnd">End Date</label>
                    <input type="date" id="taskEnd" required>
                </div>
                <div class="form-group">
                    <label for="taskEndTime">End Time (HHMM)</label>
                    <input type="time" id="taskEndTime" required>
                </div>
                <div class="form-group">
                    <label for="taskStatus">Status</label>
                    <select id="taskStatus" required>
                        <option value="pending">Pending</option>
                        <option value="in-progress">In Progress</option>
                        <option value="completed">Completed</option>
                        <option value="overdue">Overdue</option>
                        <option value="on-hold">On Hold</option>
                    </select>
                </div>
                <button type="submit" class="btn-primary">Add Task</button>
            </form>
        </div>
    </div>

    <!-- Shift Scheduling / Attendance Modal -->
    <div id="shiftSchedulingModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2>üïí Shift Scheduling & Attendance</h2>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <p>Below are clock-in/out sessions grouped by employee. Shows recent sessions.</p>
                <div id="attendanceByEmployee">Loading attendance...</div>
            </div>
            <div class="modal-actions">
                <button id="closeShiftScheduling" class="btn-secondary">Close</button>
            </div>
        </div>
    </div>
    
    <!-- Edit Task Modal -->
    <div id="editTaskModal" class="modal">
        <div class="modal-content modal-content-large">
            <span class="close">&times;</span>
            <h2>Edit Task</h2>
            <form id="editTaskForm">
                <input type="hidden" id="editTaskId">
                <div class="form-group">
                    <label for="editTaskName">Task Name</label>
                    <input type="text" id="editTaskName" required>
                </div>
                <div class="form-group">
                    <label for="editTaskStart">Start Date</label>
                    <input type="date" id="editTaskStart" required>
                </div>
                <div class="form-group">
                    <label for="editTaskStartTime">Start Time</label>
                    <input type="time" id="editTaskStartTime" required>
                </div>
                <div class="form-group">
                    <label for="editTaskEnd">End Date</label>
                    <input type="date" id="editTaskEnd" required>
                </div>
                <div class="form-group">
                    <label for="editTaskEndTime">End Time</label>
                    <input type="time" id="editTaskEndTime" required>
                </div>
                <div class="form-group">
                    <label for="editTaskStatus">Status</label>
                    <select id="editTaskStatus" required>
                        <option value="pending">Pending</option>
                        <option value="in-progress">In Progress</option>
                        <option value="completed">Completed</option>
                        <option value="overdue">Overdue</option>
                        <option value="on-hold">On Hold</option>
                    </select>
                </div>
                <div id="taskAcknowledgements" class="task-acknowledgements-section">
                    <h3>Task Acknowledgements</h3>
                    <div id="ackList" class="ack-list"></div>
                </div>
                
                <!-- Task Messages Section -->
                <div class="task-messages-section">
                    <h3>üí¨ Messages</h3>
                    <div id="taskMessagesList" class="task-messages-list">
                        <!-- Messages will be rendered here -->
                    </div>
                    <div class="task-message-input">
                        <textarea id="adminMessageInput" placeholder="Reply to employee messages..." rows="3"></textarea>
                        <button type="button" id="sendAdminMessageBtn" class="btn-primary">Send Reply</button>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="submit" class="btn-primary">Save Changes</button>
                    <button type="button" id="deleteTaskBtn" class="btn-danger">Delete Task</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Announcement Modal -->
    <div id="announcementModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>üì¢ Send Global Announcement</h2>
            <form id="announcementForm">
                <div class="form-group">
                    <label for="announcementTitle">Announcement Title</label>
                    <input type="text" id="announcementTitle" placeholder="e.g., Team Meeting Tomorrow" required>
                </div>
                <div class="form-group">
                    <label for="announcementMessage">Message</label>
                    <textarea id="announcementMessage" rows="6" placeholder="Enter your announcement message..." required></textarea>
                </div>
                <div class="form-group">
                    <label for="announcementPriority">Priority</label>
                    <select id="announcementPriority">
                        <option value="normal">Normal</option>
                        <option value="important">Important</option>
                        <option value="urgent">Urgent</option>
                    </select>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn-primary">Send to All Employees</button>
                    <button type="button" class="btn-secondary" id="cancelAnnouncementBtn">Cancel</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Notification Panel -->
    <div class="notification-overlay" id="notificationOverlay"></div>
    <div class="notification-panel" id="notificationPanel">
        <div class="notification-header">
            <h3>üîî Notifications</h3>
            <div class="notification-actions">
                <button class="notification-action-btn" id="markAllReadBtn">Mark all read</button>
                <button class="notification-action-btn" id="clearAllBtn">Clear</button>
                <button class="notification-action-btn" id="closeNotificationBtn">‚úï</button>
            </div>
        </div>
        <div class="notification-list" id="notificationList">
            <!-- Notifications will be rendered here -->
        </div>
    </div>

    <!-- Hourly Gantt Modal -->
    <div id="hourlyGanttModal" class="modal">
        <div class="modal-content modal-content-xlarge">
            <span class="close" id="closeHourlyGantt">&times;</span>
            <h2 id="hourlyGanttTitle">Hourly Schedule - Loading...</h2>
            <div class="hourly-gantt-controls">
                <button class="btn-primary" id="addHourlyTaskBtn">+ Add Hourly Task</button>
            </div>
            <div id="hourlyGanttChart" class="hourly-gantt-chart"></div>
        </div>
    </div>

    <!-- Add Hourly Task Modal -->
    <div id="addHourlyTaskModal" class="modal">
        <div class="modal-content">
            <span class="close" id="closeAddHourlyTask">&times;</span>
            <h2>Add Hourly Task</h2>
            <form id="addHourlyTaskForm">
                <div class="form-group">
                    <label for="hourlyTaskEmployee">Employee</label>
                    <select id="hourlyTaskEmployee" required>
                        <option value="">Select Employee</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="hourlyTaskName">Task Name</label>
                    <input type="text" id="hourlyTaskName" required>
                </div>
                <div class="form-group">
                    <label for="hourlyTaskCategory">Category</label>
                    <select id="hourlyTaskCategory" required>
                        <option value="">Select Category</option>
                        <option value="music-prod">Music Prod.</option>
                        <option value="video-creation">Video Creation</option>
                        <option value="administrative">Administrative</option>
                        <option value="other">Other</option>
                        <option value="note-other">Note - Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="hourlyTaskStartTime">Start Time</label>
                    <input type="time" id="hourlyTaskStartTime" required>
                </div>
                <div class="form-group">
                    <label for="hourlyTaskEndTime">End Time</label>
                    <input type="time" id="hourlyTaskEndTime" required>
                </div>
                <div class="form-group">
                    <label for="hourlyTaskStatus">Status</label>
                    <select id="hourlyTaskStatus" required>
                        <option value="pending">Pending</option>
                        <option value="in-progress">In Progress</option>
                        <option value="completed">Completed</option>
                        <option value="overdue">Overdue</option>
                        <option value="on-hold">On Hold</option>
                    </select>
                </div>
                <button type="submit" class="btn-primary">Add Task</button>
            </form>
        </div>
    </div>

    <!-- Edit Hourly Task Modal -->
    <div id="editHourlyTaskModal" class="modal">
        <div class="modal-content">
            <span class="close" id="closeEditHourlyTask">&times;</span>
            <h2>Edit Hourly Task</h2>
            <form id="editHourlyTaskForm">
                <input type="hidden" id="editHourlyTaskId">
                
                <div class="form-group">
                    <label for="editHourlyTaskName">Task Name</label>
                    <input type="text" id="editHourlyTaskName" required>
                </div>
                
                <div class="form-group">
                    <label for="editHourlyTaskCategory">Category</label>
                    <select id="editHourlyTaskCategory" required>
                        <option value="music-prod">Music Prod.</option>
                        <option value="video-creation">Video Creation</option>
                        <option value="administrative">Administrative</option>
                        <option value="other">Other</option>
                        <option value="note-other">Note - Other</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="editHourlyTaskStartTime">Start Time</label>
                    <input type="time" id="editHourlyTaskStartTime" required>
                </div>
                
                <div class="form-group">
                    <label for="editHourlyTaskEndTime">End Time</label>
                    <input type="time" id="editHourlyTaskEndTime" required>
                </div>
                
                <div class="form-group">
                    <label for="editHourlyTaskStatus">Status</label>
                    <select id="editHourlyTaskStatus" required>
                        <option value="pending">Pending</option>
                        <option value="in-progress">In Progress</option>
                        <option value="completed">Completed</option>
                        <option value="overdue">Overdue</option>
                        <option value="on-hold">On Hold</option>
                    </select>
                </div>
                
                <div class="form-actions">
                    <button type="submit" class="btn-primary">Save Changes</button>
                    <button type="button" class="btn-danger" id="deleteHourlyTaskBtn">Delete Task</button>
                    <button type="button" class="btn-secondary" id="cancelEditHourlyTask">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Shift Modal -->
    <div id="editShiftModal" class="modal">
        <div class="modal-content">
            <span class="close" id="closeEditShift">&times;</span>
            <h2>Edit Shift Time</h2>
            <form id="editShiftForm">
                <input type="hidden" id="editShiftEmployeeId">
                <input type="hidden" id="editShiftDate">
                <input type="hidden" id="editShiftId">
                
                <div class="form-group">
                    <label for="editShiftEmployeeName">Employee</label>
                    <input type="text" id="editShiftEmployeeName" disabled>
                </div>
                
                <div class="form-group">
                    <label for="editShiftStartTime">Start Time</label>
                    <input type="time" id="editShiftStartTime" required>
                </div>
                
                <div class="form-group">
                    <label for="editShiftEndTime">End Time</label>
                    <input type="time" id="editShiftEndTime" required>
                </div>
                
                <div class="form-actions">
                    <button type="submit" class="btn-primary">Update Shift</button>
                    <button type="button" class="btn-danger" id="deleteShiftBtn" style="display: none;">Delete Shift</button>
                    <button type="button" class="btn-secondary" id="cancelEditShift">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Payroll Hours Management Modal -->
    <div id="payrollHoursModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <span class="close" id="closePayrollHours">&times;</span>
            <h2>üí∞ Set Payroll Hours</h2>
            <div class="form-group">
                <label for="payrollPeriodStart">Pay Period Start</label>
                <input type="date" id="payrollPeriodStart" required>
            </div>
            <div class="form-group">
                <label for="payrollPeriodEnd">Pay Period End</label>
                <input type="date" id="payrollPeriodEnd" required>
            </div>
            <div id="payrollHoursList" style="max-height: 500px; overflow-y: auto; margin: 20px 0;">
                <div style="text-align: center; padding: 20px; color: #64748b;">Loading employees...</div>
            </div>
            <div class="form-actions">
                <button id="savePayrollHoursBtn" class="btn-primary">Save All Hours</button>
                <button type="button" class="btn-secondary" id="cancelPayrollHours">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Accountant Access Management Modal -->
    <div id="accountantAccessModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <span class="close" id="closeAccountantAccess">&times;</span>
            <h2>üë§ Accountant Access Management</h2>
            <p style="color: #64748b; margin-bottom: 20px;">
                Designate which employees the accountant can view and process payroll for.
            </p>
            <div id="accountantAccessList" style="max-height: 500px; overflow-y: auto; margin: 20px 0;">
                <div style="text-align: center; padding: 20px; color: #64748b;">Loading employees...</div>
            </div>
            <div class="form-actions">
                <button id="saveAccountantAccessBtn" class="btn-primary">Save Access Settings</button>
                <button type="button" class="btn-secondary" id="cancelAccountantAccess">Cancel</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Immediate authentication check - runs before page loads
        (function() {
            const employmentStatus = sessionStorage.getItem('employmentStatus');
            const userRole = sessionStorage.getItem('userRole');
            
            // Check if user is on extended leave
            if (employmentStatus === 'extended_leave') {
                window.location.href = 'extended-leave.html';
                return;
            }
            
            // Check if user is authenticated as admin
            if (!userRole || userRole !== 'admin') {
                window.location.href = 'index.html';
                return;
            }
        })();
    </script>
    <script src="scripts/supabase.js"></script>
    <script src="scripts/config.js"></script>
    <script src="scripts/employee-status-monitor.js"></script>
    <script src="scripts/checkin.js"></script>
    <script src="scripts/time-admin.js"></script>
    <script src="scripts/notifications.js"></script>
    <script src="scripts/announcement-banner.js"></script>
    <script src="scripts/gantt-context-menu.js"></script>
    <script src="scripts/gantt.js"></script>
    <script>
        // Ensure GanttChart is loaded before admin.js
        if (typeof GanttChart === 'undefined') {
            console.error('CRITICAL: GanttChart is not defined after loading gantt.js');
        } else {
            console.log('‚úÖ GanttChart class is available');
        }
    </script>
    <script src="scripts/hourly-gantt.js"></script>
    <script src="scripts/admin.js"></script>
    <script src="scripts/company-chat.js"></script>
    <script src="scripts/voip-call-manager.js"></script>
    <script src="scripts/voip-ui.js"></script>
    <script>
        // Initialize VOIP on page load
        document.addEventListener('DOMContentLoaded', async () => {
            // Show page load screen on initial load
            if (typeof showPageLoadScreen !== 'undefined') {
                showPageLoadScreen();
            }
            if (typeof voipUI !== 'undefined') {
                await voipUI.initialize();
            }
        });
    </script>
    
    <!-- Wage Garnishment Management Modal -->
    <div id="garnishmentModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <span class="close" id="closeGarnishment">&times;</span>
            <h2>‚öñÔ∏è Wage Garnishment Management</h2>
            <div style="margin-bottom: 20px;">
                <button id="addGarnishmentBtn" class="btn-primary" style="margin-bottom: 15px;">+ Add New Garnishment</button>
                <button id="deductWalletBtn" class="btn-primary btn-danger" style="margin-bottom: 15px; margin-left: 10px;">üí∞ Deduct from Wallet</button>
            </div>
            <div id="garnishmentsList" style="max-height: 500px; overflow-y: auto; margin: 20px 0;">
                <div style="text-align: center; padding: 20px; color: #64748b;">Loading garnishments...</div>
            </div>
            <div class="form-actions">
                <button type="button" class="btn-secondary" id="cancelGarnishment">Close</button>
            </div>
        </div>
    </div>
    
    <!-- Employee Balances Modal -->
    <div id="employeeBalancesModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <span class="close" id="closeEmployeeBalances">&times;</span>
            <h2>üí∞ Employee Wallet Balances</h2>
            <div style="margin-bottom: 20px;">
                <input type="text" id="balanceSearchInput" placeholder="Search employees..." 
                       style="width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 4px;">
            </div>
            <div id="employeeBalancesList" style="max-height: 600px; overflow-y: auto; margin: 20px 0;">
                <div style="text-align: center; padding: 20px; color: #64748b;">Loading employee balances...</div>
            </div>
            <div class="form-actions">
                <button type="button" class="btn-secondary" id="cancelEmployeeBalances">Close</button>
            </div>
        </div>
    </div>
    
    <!-- Direct Wallet Deduction Modal -->
    <div id="deductWalletModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <span class="close" id="closeDeductWallet">&times;</span>
            <h2>üí∞ Direct Wallet Deduction</h2>
            <p style="color: #64748b; margin-bottom: 20px; font-size: 14px;">
                Directly deduct money from an employee's wallet. This is separate from wage garnishments.
            </p>
            <form id="deductWalletForm">
                <div class="form-group">
                    <label for="deductWalletEmployee">Employee</label>
                    <select id="deductWalletEmployee" required>
                        <option value="">Select an employee...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="deductWalletAmount">Amount ($)</label>
                    <input type="number" id="deductWalletAmount" step="0.01" min="0.01" required>
                </div>
                <div class="form-group">
                    <label for="deductWalletReason">Reason</label>
                    <textarea id="deductWalletReason" rows="3" placeholder="Enter reason for deduction..." required></textarea>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn-primary btn-danger">Deduct from Wallet</button>
                    <button type="button" class="btn-secondary" id="cancelDeductWallet">Cancel</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Add/Edit Garnishment Modal -->
    <div id="addGarnishmentModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <span class="close" id="closeAddGarnishment">&times;</span>
            <h2 id="garnishmentModalTitle">Add Wage Garnishment</h2>
            <form id="garnishmentForm">
                <input type="hidden" id="garnishmentId">
                <div class="form-group">
                    <label for="garnishmentEmployee">Employee</label>
                    <select id="garnishmentEmployee" required>
                        <option value="">Select an employee...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="garnishmentAmountType">Amount Type</label>
                    <select id="garnishmentAmountType" required>
                        <option value="fixed">Fixed Amount ($)</option>
                        <option value="percent">Percentage of Pay (%)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label id="garnishmentAmountLabel" for="garnishmentAmount">Amount ($)</label>
                    <input type="number" id="garnishmentAmount" step="0.01" min="0" required>
                </div>
                <div class="form-group">
                    <label for="garnishmentReason">Reason</label>
                    <textarea id="garnishmentReason" rows="3" placeholder="Enter reason for wage garnishment..." required></textarea>
                </div>
                <div class="form-group">
                    <label for="garnishmentStartDate">Start Date</label>
                    <input type="date" id="garnishmentStartDate" required>
                </div>
                <div class="form-group">
                    <label for="garnishmentEndDate">End Date (Optional - leave blank for indefinite)</label>
                    <input type="date" id="garnishmentEndDate">
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn-primary">Save Garnishment</button>
                    <button type="button" class="btn-secondary" id="cancelAddGarnishment">Cancel</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Stock Management Modal -->
    <div id="stockManagementModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <span class="close" id="closeStockManagement">&times;</span>
            <h2>üìà Stock Market Management</h2>
            <div style="margin-bottom: 20px;">
                <div style="display: flex; gap: 20px; margin-bottom: 20px; border-bottom: 2px solid #e5e7eb; padding-bottom: 15px;">
                    <button id="addRealStockTab" class="btn-primary" style="flex: 1;">Add NYSE Stock</button>
                    <button id="addSimulatedStockTab" class="btn-secondary" style="flex: 1;">Add Simulated Stock</button>
                </div>
                
                <!-- Add Real NYSE Stock Form -->
                <div id="addRealStockForm" style="display: block;">
                    <h3>Add Real NYSE Stock</h3>
                    <p style="color: #64748b; margin-bottom: 15px; font-size: 14px;">
                        Enter a stock symbol to automatically fetch real-time data from NYSE. The stock will update with real market prices.
                    </p>
                    <form id="addRealStockFormElement" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                        <div class="form-group" style="grid-column: 1 / -1;">
                            <label for="realStockSymbol">Stock Symbol (e.g., AAPL, MSFT, GOOGL)</label>
                            <input type="text" id="realStockSymbol" placeholder="AAPL" maxlength="10" required style="text-transform: uppercase;">
                            <small style="color: #6b7280; font-size: 12px;">Enter a valid NYSE or NASDAQ stock symbol</small>
                        </div>
                        <div class="form-group" style="grid-column: 1 / -1;">
                            <button type="submit" class="btn-primary">Fetch & Add Real Stock</button>
                        </div>
                    </form>
                </div>
                
                <!-- Add Simulated Stock Form -->
                <div id="addSimulatedStockForm" style="display: none;">
                    <h3>Add Simulated Stock</h3>
                    <p style="color: #64748b; margin-bottom: 15px; font-size: 14px;">
                        Create a custom simulated stock with manual pricing and volatility settings.
                    </p>
                    <form id="addStockForm" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                        <div class="form-group">
                            <label for="newStockSymbol">Stock Symbol</label>
                            <input type="text" id="newStockSymbol" placeholder="AAPL" maxlength="10" required>
                        </div>
                        <div class="form-group">
                            <label for="newStockCompany">Company Name</label>
                            <input type="text" id="newStockCompany" placeholder="Apple Inc." required>
                        </div>
                        <div class="form-group">
                            <label for="newStockPrice">Initial Price ($)</label>
                            <input type="number" id="newStockPrice" step="0.01" min="0.01" placeholder="100.00" required>
                        </div>
                        <div class="form-group">
                            <label for="newStockVolatility">Volatility (%)</label>
                            <input type="number" id="newStockVolatility" step="0.01" min="0" max="100" placeholder="10.00" value="10.00" required>
                        </div>
                        <div class="form-group" style="grid-column: 1 / -1;">
                            <button type="submit" class="btn-primary">Add Simulated Stock</button>
                        </div>
                    </form>
                </div>
            </div>
            <div>
                <h3>Existing Stocks</h3>
                <div id="stocksList" style="max-height: 400px; overflow-y: auto; margin-top: 15px;">
                    <div style="text-align: center; padding: 20px; color: #64748b;">Loading stocks...</div>
                </div>
            </div>
            <div class="form-actions" style="margin-top: 20px;">
                <button type="button" class="btn-secondary" id="cancelStockManagement">Close</button>
            </div>
        </div>
    </div>
    
    <!-- ADDED UI: Footer with version/copyright -->
    <footer class="dashboard-footer">
        <p>WaterROC v2.1.4 &copy; 2024 Waterstream Resource Operations Center</p>
    </footer>
    
    <!-- LOGIC: Enhanced Gantt interactions -->
    <script src="scripts/gantt-enhancements.js"></script>
</body>
</html>
